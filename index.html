<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Background Remover - Fixed</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container { max-width: 900px; margin: 0 auto; }

        h1 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #00d4ff, #7b2dff, #ff2d7c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle { text-align: center; color: #666; margin-bottom: 30px; }

        .card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
        }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }

        .tab {
            flex: 1;
            padding: 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #888;
            cursor: pointer;
            text-align: center;
            transition: 0.3s;
            font-weight: 500;
        }

        .tab:hover { background: rgba(255,255,255,0.08); }
        .tab.active {
            background: linear-gradient(135deg, #7b2dff, #00d4ff);
            color: #fff;
            border-color: transparent;
        }

        /* Upload */
        .upload-zone {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }

        .upload-zone:hover {
            border-color: #00d4ff;
            background: rgba(0,212,255,0.05);
        }

        .upload-zone.dragover {
            border-color: #7b2dff;
            background: rgba(123,45,255,0.1);
        }

        .upload-icon { font-size: 3.5rem; margin-bottom: 15px; }
        #fileInput { display: none; }

        /* Settings */
        .settings-row {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .setting-item {
            flex: 1;
            min-width: 150px;
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
        }

        .setting-item label {
            display: block;
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
        }

        .setting-item select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3);
            color: #fff;
        }

        /* Progress */
        .progress-section {
            display: none;
            text-align: center;
            padding: 50px 20px;
        }

        .spinner-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: #00d4ff;
            border-right-color: #7b2dff;
            animation: spin 1s linear infinite;
        }

        .spinner-percent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            font-weight: bold;
            color: #00d4ff;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .progress-text { 
            color: #aaa; 
            font-size: 1rem; 
            margin-bottom: 10px;
        }

        .progress-sub {
            color: #555;
            font-size: 0.85rem;
        }

        /* Result */
        .result-section { display: none; }

        .compare-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .compare-grid { grid-template-columns: 1fr; }
        }

        .img-box {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: repeating-conic-gradient(#1a1a1a 0% 25%, #222 0% 50%) 50% / 15px 15px;
            min-height: 200px;
        }

        .img-box img { width: 100%; display: block; }

        .img-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .img-info {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #00d4ff;
        }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }

        .btn {
            flex: 1;
            min-width: 140px;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #7b2dff, #00d4ff);
            color: #fff;
        }

        .btn-success {
            background: linear-gradient(135deg, #00c853, #00e676);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Manual Controls */
        .manual-section { display: none; }

        .picker-canvas {
            max-width: 100%;
            max-height: 350px;
            border-radius: 10px;
            cursor: crosshair;
            display: block;
            margin: 0 auto 20px;
            border: 2px solid #333;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-item label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #aaa;
        }

        .control-item input[type="range"] {
            width: 100%;
            accent-color: #7b2dff;
        }

        .color-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #colorPicker {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #colorHex {
            flex: 1;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #fff;
            font-family: monospace;
        }

        /* Alert */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            font-size: 0.9rem;
        }

        .alert-error {
            background: rgba(255,45,124,0.15);
            border: 1px solid rgba(255,45,124,0.3);
            color: #ff6b9d;
        }

        .alert-info {
            background: rgba(0,212,255,0.1);
            border: 1px solid rgba(0,212,255,0.3);
            color: #00d4ff;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ú® AI Background Remover</h1>
        <p class="subtitle">Hapus background foto secara otomatis dengan AI</p>

        <div class="alert alert-error" id="alertError"></div>
        <div class="alert alert-info" id="alertInfo"></div>

        <div class="card">
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" data-mode="ai" onclick="switchTab('ai')">
                    ü§ñ Mode AI (Otomatis)
                </div>
                <div class="tab" data-mode="manual" onclick="switchTab('manual')">
                    üé® Mode Manual (Chroma Key)
                </div>
            </div>

            <!-- Upload Zone -->
            <div id="uploadZone" class="upload-zone">
                <div class="upload-icon">üñºÔ∏è</div>
                <h3>Klik atau Drop Foto Disini</h3>
                <p style="color:#666; margin-top:10px;">JPG, PNG, WebP</p>
                <input type="file" id="fileInput" accept="image/*">
            </div>

            <!-- Settings -->
            <div class="settings-row" id="settingsRow">
                <div class="setting-item">
                    <label>üìê Max Resolusi</label>
                    <select id="maxSize">
                        <option value="4096">4096px (Best Quality)</option>
                        <option value="2048" selected>2048px (Recommended)</option>
                        <option value="1024">1024px (Fast)</option>
                        <option value="512">512px (Very Fast)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>üñºÔ∏è Format</label>
                    <select id="outputFormat">
                        <option value="png">PNG (Transparent)</option>
                        <option value="webp">WebP (Smaller)</option>
                    </select>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <div class="spinner-container">
                    <div class="spinner"></div>
                    <div class="spinner-percent" id="progressPercent">0%</div>
                </div>
                <p class="progress-text" id="progressText">Memulai...</p>
                <p class="progress-sub" id="progressSub">Mohon tunggu, jangan refresh halaman</p>
            </div>

            <!-- Manual Section -->
            <div class="manual-section" id="manualSection">
                <p style="color:#888; font-size:0.9rem; margin-bottom:15px; text-align:center;">
                    üí° Klik pada gambar untuk memilih warna background yang ingin dihapus
                </p>
                
                <canvas id="pickerCanvas" class="picker-canvas"></canvas>

                <div class="controls-grid">
                    <div class="control-item">
                        <label>Warna Target</label>
                        <div class="color-row">
                            <input type="color" id="colorPicker" value="#00ff00">
                            <input type="text" id="colorHex" value="#00ff00">
                        </div>
                    </div>
                    <div class="control-item">
                        <label>Toleransi <span id="tolVal">35</span></label>
                        <input type="range" id="tolerance" min="1" max="150" value="35">
                    </div>
                    <div class="control-item">
                        <label>Kehalusan <span id="softVal">15</span></label>
                        <input type="range" id="softness" min="0" max="50" value="15">
                    </div>
                    <div class="control-item">
                        <label>Despill <span id="despillVal">50</span></label>
                        <input type="range" id="despill" min="0" max="100" value="50">
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="processManual()">‚ö° Proses Chroma Key</button>
                </div>
            </div>

            <!-- Result Section -->
            <div class="result-section" id="resultSection">
                <div class="compare-grid">
                    <div class="img-box">
                        <span class="img-label">üì∑ Original</span>
                        <img id="originalImg" alt="Original">
                        <span class="img-info" id="originalInfo">-</span>
                    </div>
                    <div class="img-box">
                        <span class="img-label">‚úÖ Hasil</span>
                        <img id="resultImg" alt="Result">
                        <span class="img-info" id="resultInfo">-</span>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="downloadResult()">üì• Download</button>
                    <button class="btn btn-secondary" onclick="resetAll()">üîÑ Foto Baru</button>
                </div>
            </div>
        </div>

        <!-- Tips -->
        <div class="card" style="padding: 15px;">
            <p style="font-size: 0.85rem; color: #888;">
                <strong style="color:#00d4ff;">üí° Tips:</strong> 
                Mode AI bekerja otomatis untuk foto orang/objek apapun. 
                Mode Manual cocok untuk background warna solid (green screen).
                <br><br>
                <strong style="color:#ff6b9d;">‚ö†Ô∏è Penting:</strong> 
                Pertama kali butuh download model AI (~50MB). Setelah itu akan lebih cepat.
            </p>
        </div>
    </div>

    <!-- Hidden Canvases -->
    <canvas id="workCanvas" style="display:none;"></canvas>
    <canvas id="outputCanvas" style="display:none;"></canvas>

    <script type="module">
        // ============ IMPORT ============
        import { 
            AutoModel, 
            AutoProcessor, 
            RawImage,
            env 
        } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

        env.allowLocalModels = false;
        env.useBrowserCache = true;

        // ============ VARIABLES ============
        let currentMode = 'ai';
        let currentFile = null;
        let model = null;
        let processor = null;
        let resultBlob = null;
        let originalImageData = null;

        // DOM Elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const settingsRow = document.getElementById('settingsRow');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const progressSub = document.getElementById('progressSub');
        const progressPercent = document.getElementById('progressPercent');
        const manualSection = document.getElementById('manualSection');
        const resultSection = document.getElementById('resultSection');
        const originalImg = document.getElementById('originalImg');
        const resultImg = document.getElementById('resultImg');
        const alertError = document.getElementById('alertError');
        const alertInfo = document.getElementById('alertInfo');

        const pickerCanvas = document.getElementById('pickerCanvas');
        const pickerCtx = pickerCanvas.getContext('2d');
        const workCanvas = document.getElementById('workCanvas');
        const workCtx = workCanvas.getContext('2d');
        const outputCanvas = document.getElementById('outputCanvas');
        const outputCtx = outputCanvas.getContext('2d');

        // ============ EVENTS ============

        uploadZone.onclick = () => fileInput.click();

        uploadZone.ondragover = (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        };

        uploadZone.ondragleave = () => uploadZone.classList.remove('dragover');

        uploadZone.ondrop = (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        };

        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        // Color picker sync
        document.getElementById('colorPicker').oninput = (e) => {
            document.getElementById('colorHex').value = e.target.value;
        };

        document.getElementById('colorHex').onchange = (e) => {
            if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                document.getElementById('colorPicker').value = e.target.value;
            }
        };

        // Sliders
        document.getElementById('tolerance').oninput = (e) => {
            document.getElementById('tolVal').textContent = e.target.value;
        };
        document.getElementById('softness').oninput = (e) => {
            document.getElementById('softVal').textContent = e.target.value;
        };
        document.getElementById('despill').oninput = (e) => {
            document.getElementById('despillVal').textContent = e.target.value;
        };

        // Canvas color pick
        pickerCanvas.onclick = (e) => {
            const rect = pickerCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (pickerCanvas.width / rect.width);
            const y = (e.clientY - rect.top) * (pickerCanvas.height / rect.height);
            const pixel = pickerCtx.getImageData(Math.floor(x), Math.floor(y), 1, 1).data;
            const hex = '#' + [pixel[0], pixel[1], pixel[2]].map(v => v.toString(16).padStart(2, '0')).join('');
            document.getElementById('colorPicker').value = hex;
            document.getElementById('colorHex').value = hex;
        };

        // ============ FUNCTIONS ============

        window.switchTab = function(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.mode === mode);
            });

            if (currentFile && mode === 'manual') {
                loadForManual();
            } else if (!currentFile) {
                manualSection.style.display = 'none';
            }
        };

        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                showError('Pilih file gambar yang valid (JPG, PNG, WebP)');
                return;
            }

            hideAlerts();
            currentFile = file;
            originalImg.src = URL.createObjectURL(file);
            document.getElementById('originalInfo').textContent = formatFileSize(file.size);

            if (currentMode === 'ai') {
                processAI();
            } else {
                loadForManual();
            }
        }

        async function processAI() {
            showProgress('Memulai proses AI...', 'Menyiapkan gambar', 0);

            try {
                // 1. Resize image
                const maxSize = parseInt(document.getElementById('maxSize').value);
                updateProgress('Mengoptimalkan gambar...', '', 5);
                const resizedBlob = await resizeImage(currentFile, maxSize);

                // 2. Load model if not loaded
                if (!model || !processor) {
                    updateProgress('Memuat model AI...', 'Download ~50MB (hanya sekali)', 10);
                    
                    processor = await AutoProcessor.from_pretrained('briaai/RMBG-1.4', {
                        progress_callback: (p) => {
                            if (p.status === 'progress' && p.total) {
                                const pct = 10 + Math.round((p.loaded / p.total) * 20);
                                updateProgress('Memuat processor...', `${Math.round(p.loaded/1024/1024)}MB / ${Math.round(p.total/1024/1024)}MB`, pct);
                            }
                        }
                    });

                    model = await AutoModel.from_pretrained('briaai/RMBG-1.4', {
                        progress_callback: (p) => {
                            if (p.status === 'progress' && p.total) {
                                const pct = 30 + Math.round((p.loaded / p.total) * 40);
                                updateProgress('Memuat model AI...', `${Math.round(p.loaded/1024/1024)}MB / ${Math.round(p.total/1024/1024)}MB`, pct);
                            }
                        }
                    });
                }

                // 3. Process image
                updateProgress('Menganalisis gambar...', 'Mendeteksi objek', 75);
                
                const image = await RawImage.fromBlob(resizedBlob);
                const { pixel_values } = await processor(image);

                updateProgress('Menghapus background...', 'Membuat mask', 85);

                const { output } = await model({ input: pixel_values });

                // 4. Create mask and apply
                updateProgress('Membuat hasil akhir...', 'Hampir selesai', 95);

                // Convert output tensor to mask image
                const maskTensor = output[0].mul(255).clamp(0, 255).to('uint8');
                const maskData = maskTensor.data;
                const [height, width] = [maskTensor.dims[1], maskTensor.dims[2]];

                // Apply mask to original image
                await applyMaskToImage(resizedBlob, maskData, width, height);

                updateProgress('Selesai!', '‚úÖ', 100);
                
                setTimeout(() => showResult(), 500);

            } catch (error) {
                console.error('AI Error:', error);
                hideProgress();
                showError(`Gagal: ${error.message}. Coba Mode Manual atau refresh halaman.`);
            }
        }

        async function resizeImage(file, maxSize) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let { width, height } = img;
                    
                    if (width <= maxSize && height <= maxSize) {
                        resolve(file);
                        return;
                    }

                    const ratio = Math.min(maxSize / width, maxSize / height);
                    width = Math.round(width * ratio);
                    height = Math.round(height * ratio);

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    canvas.toBlob(resolve, 'image/png');
                };
                img.src = URL.createObjectURL(file);
            });
        }

        async function applyMaskToImage(originalBlob, maskData, maskW, maskH) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    // Set output canvas to image size
                    outputCanvas.width = img.width;
                    outputCanvas.height = img.height;

                    // Draw original image
                    outputCtx.drawImage(img, 0, 0);
                    const imageData = outputCtx.getImageData(0, 0, img.width, img.height);

                    // Create temp canvas for mask resizing
                    const maskCanvas = document.createElement('canvas');
                    maskCanvas.width = maskW;
                    maskCanvas.height = maskH;
                    const maskCtx = maskCanvas.getContext('2d');
                    
                    // Create ImageData from mask
                    const maskImageData = maskCtx.createImageData(maskW, maskH);
                    for (let i = 0; i < maskData.length; i++) {
                        const idx = i * 4;
                        maskImageData.data[idx] = maskData[i];     // R
                        maskImageData.data[idx + 1] = maskData[i]; // G
                        maskImageData.data[idx + 2] = maskData[i]; // B
                        maskImageData.data[idx + 3] = 255;         // A
                    }
                    maskCtx.putImageData(maskImageData, 0, 0);

                    // Resize mask to match image
                    const resizeMaskCanvas = document.createElement('canvas');
                    resizeMaskCanvas.width = img.width;
                    resizeMaskCanvas.height = img.height;
                    const resizeMaskCtx = resizeMaskCanvas.getContext('2d');
                    resizeMaskCtx.drawImage(maskCanvas, 0, 0, img.width, img.height);
                    const resizedMask = resizeMaskCtx.getImageData(0, 0, img.width, img.height);

                    // Apply mask to alpha channel
                    for (let i = 0; i < imageData.data.length; i += 4) {
                        imageData.data[i + 3] = resizedMask.data[i]; // Use R channel as alpha
                    }

                    outputCtx.putImageData(imageData, 0, 0);

                    // Convert to blob
                    const format = document.getElementById('outputFormat').value;
                    const mime = format === 'webp' ? 'image/webp' : 'image/png';
                    
                    outputCanvas.toBlob((blob) => {
                        resultBlob = blob;
                        resultImg.src = URL.createObjectURL(blob);
                        document.getElementById('resultInfo').textContent = 
                            `${img.width}√ó${img.height} ‚Ä¢ ${formatFileSize(blob.size)}`;
                        resolve();
                    }, mime, 0.95);
                };
                img.src = URL.createObjectURL(originalBlob);
            });
        }

        function loadForManual() {
            const img = new Image();
            img.onload = () => {
                const maxSize = parseInt(document.getElementById('maxSize').value);
                let { width, height } = img;

                const ratio = Math.min(1, maxSize / Math.max(width, height));
                width = Math.round(width * ratio);
                height = Math.round(height * ratio);

                // Display canvas
                const displayRatio = Math.min(1, 500 / Math.max(width, height));
                pickerCanvas.width = width * displayRatio;
                pickerCanvas.height = height * displayRatio;
                pickerCtx.drawImage(img, 0, 0, pickerCanvas.width, pickerCanvas.height);

                // Work canvas (full size)
                workCanvas.width = width;
                workCanvas.height = height;
                workCtx.drawImage(img, 0, 0, width, height);
                originalImageData = workCtx.getImageData(0, 0, width, height);

                outputCanvas.width = width;
                outputCanvas.height = height;

                // Show manual UI
                uploadZone.style.display = 'none';
                settingsRow.style.display = 'none';
                manualSection.style.display = 'block';
                resultSection.style.display = 'none';
            };
            img.src = URL.createObjectURL(currentFile);
        }

        window.processManual = function() {
            const target = hexToRgb(document.getElementById('colorPicker').value);
            const tolerance = parseInt(document.getElementById('tolerance').value);
            const softness = parseInt(document.getElementById('softness').value);
            const despill = parseInt(document.getElementById('despill').value) / 100;

            const output = new ImageData(
                new Uint8ClampedArray(originalImageData.data),
                originalImageData.width,
                originalImageData.height
            );
            const data = output.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i + 1], b = data[i + 2];
                const dist = Math.sqrt((r - target.r) ** 2 + (g - target.g) ** 2 + (b - target.b) ** 2);

                let alpha = 255;
                if (dist < tolerance) {
                    alpha = 0;
                } else if (dist < tolerance + softness) {
                    alpha = ((dist - tolerance) / softness) * 255;
                }

                // Despill
                if (alpha > 0 && dist < tolerance + softness + 60) {
                    const factor = Math.max(0, 1 - dist / (tolerance + 100));
                    const gray = r * 0.299 + g * 0.587 + b * 0.114;
                    const str = factor * despill;
                    data[i] = r * (1 - str) + gray * str;
                    data[i + 1] = g * (1 - str) + gray * str;
                    data[i + 2] = b * (1 - str) + gray * str;
                }

                data[i + 3] = Math.round(alpha);
            }

            outputCtx.putImageData(output, 0, 0);

            const format = document.getElementById('outputFormat').value;
            const mime = format === 'webp' ? 'image/webp' : 'image/png';

            outputCanvas.toBlob((blob) => {
                resultBlob = blob;
                resultImg.src = URL.createObjectURL(blob);
                document.getElementById('resultInfo').textContent = 
                    `${outputCanvas.width}√ó${outputCanvas.height} ‚Ä¢ ${formatFileSize(blob.size)}`;
                showResult();
            }, mime, 0.95);
        };

        window.downloadResult = function() {
            if (!resultBlob) return;
            const ext = document.getElementById('outputFormat').value;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(resultBlob);
            a.download = `no-background.${ext}`;
            a.click();
        };

        window.resetAll = function() {
            currentFile = null;
            resultBlob = null;
            fileInput.value = '';
            
            uploadZone.style.display = 'block';
            settingsRow.style.display = 'flex';
            progressSection.style.display = 'none';
            manualSection.style.display = 'none';
            resultSection.style.display = 'none';
            
            hideAlerts();
        };

        // ============ UI HELPERS ============

        function showProgress(text, sub, percent) {
            uploadZone.style.display = 'none';
            settingsRow.style.display = 'none';
            resultSection.style.display = 'none';
            manualSection.style.display = 'none';
            progressSection.style.display = 'block';
            updateProgress(text, sub, percent);
        }

        function updateProgress(text, sub, percent) {
            progressText.textContent = text;
            progressSub.textContent = sub;
            progressPercent.textContent = percent + '%';
        }

        function hideProgress() {
            progressSection.style.display = 'none';
            uploadZone.style.display = 'block';
            settingsRow.style.display = 'flex';
        }

        function showResult() {
            progressSection.style.display = 'none';
            manualSection.style.display = 'none';
            resultSection.style.display = 'block';
        }

        function showError(msg) {
            alertError.innerHTML = '‚ùå ' + msg;
            alertError.style.display = 'block';
            alertInfo.style.display = 'none';
        }

        function showInfo(msg) {
            alertInfo.innerHTML = 'üí° ' + msg;
            alertInfo.style.display = 'block';
            alertError.style.display = 'none';
        }

        function hideAlerts() {
            alertError.style.display = 'none';
            alertInfo.style.display = 'none';
        }

        function hexToRgb(hex) {
            const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return r ? {
                r: parseInt(r[1], 16),
                g: parseInt(r[2], 16),
                b: parseInt(r[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1024 / 1024).toFixed(2) + ' MB';
        }

    </script>
</body>
</html>
